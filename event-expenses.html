<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>×”×•×¦××•×ª ××™×¨×•×¢</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="event.css">
</head>
<body>
    <!-- ×›×¤×ª×•×¨ ×—×–×¨×” -->
    <div class="close-page-btn" onclick="goBack()">âœ•</div>
    
    <!-- ×ª×¤×¨×™×˜ ×”××‘×•×¨×’×¨ -->
    <div class="hamburger-menu" onclick="toggleMenu()">
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
    </div>
    
    <!-- ×ª×¤×¨×™×˜ ×¦×“ -->
    <div id="sideMenu" class="side-menu">
        <div class="menu-header">
            <h2>×ª×¤×¨×™×˜</h2>
            <button class="close-btn" onclick="toggleMenu()">âœ•</button>
        </div>
        <div class="menu-items">
            <a href="index.html">ğŸ  ×“×£ ×”×‘×™×ª</a>
            <a href="shopping.html">ğŸ›’ ×¨×©×™××ª ×§× ×™×•×ª</a>
            <a href="apartment.html">ğŸ¢ ×“×™×¨×”</a>
            <a href="calendar.html">ğŸ“… ×œ×•×— ×©× ×”</a>
        </div>
    </div>
    
    <!-- ×¨×§×¢ ×›×”×” -->
    <div id="menuOverlay" class="menu-overlay" onclick="toggleMenu()"></div>
    
    <div class="container event-page-container">
        <h1>ğŸ’° ×”×•×¦××•×ª</h1>
        <div id="eventSubtitle" class="event-subtitle"></div>
        
        <div class="add-form">
            <div class="add-form-row">
                <input type="text" id="expenseName" placeholder="×©× ×”×”×•×¦××”" />
                <input type="number" id="expensePrice" placeholder="××—×™×¨ (â‚ª)" min="0" style="max-width:120px;" />
            </div>
            <button class="btn" onclick="addExpense()">â• ×”×•×¡×£ ×”×•×¦××”</button>
        </div>
        
        <ul id="expensesList" class="event-list"></ul>
        
        <div id="totalExpenses" class="total-expenses" style="display:none;">
            <span class="total-label">×¡×”"×›:</span>
            <span class="total-amount" id="totalAmount">â‚ª0</span>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="firebase.js"></script>
    <script src="menu.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('id');
        
        if (!eventId) {
            window.location.href = 'index.html';
        }
        
        let expenses = [];
        
        // ×˜×¢×™× ×ª ×©× ×”××™×¨×•×¢
        db.collection('userEvents').doc(eventId).get().then(doc => {
            if (doc.exists) {
                document.getElementById('eventSubtitle').textContent = doc.data().name;
            }
        });
        
        // ×”××–× ×” ×œ×”×•×¦××•×ª
        db.collection('eventExpenses')
            .where('eventId', '==', eventId)
            .onSnapshot(snapshot => {
                expenses = [];
                snapshot.forEach(doc => {
                    expenses.push({ id: doc.id, ...doc.data() });
                });
                renderExpenses();
            });
        
        function renderExpenses() {
            const list = document.getElementById('expensesList');
            const totalDiv = document.getElementById('totalExpenses');
            
            if (expenses.length === 0) {
                list.innerHTML = '<div class="empty-message">××™×Ÿ ×”×•×¦××•×ª ×¢×“×™×™×Ÿ</div>';
                totalDiv.style.display = 'none';
                return;
            }
            
            list.innerHTML = expenses.map(exp => `
                <li>
                    <div class="item-info">
                        <div class="item-name">${exp.name}</div>
                    </div>
                    <span class="item-price">â‚ª${exp.price}</span>
                    <button class="delete-btn" onclick="deleteExpense('${exp.id}')">ğŸ—‘ï¸</button>
                </li>
            `).join('');
            
            const total = expenses.reduce((sum, exp) => sum + (parseFloat(exp.price) || 0), 0);
            document.getElementById('totalAmount').textContent = 'â‚ª' + total.toLocaleString();
            totalDiv.style.display = 'flex';
        }
        
        function addExpense() {
            const name = document.getElementById('expenseName').value.trim();
            const price = document.getElementById('expensePrice').value;
            
            if (!name || !price) {
                alert('× × ×œ××œ× ×©× ×•××—×™×¨');
                return;
            }
            
            db.collection('eventExpenses').add({
                eventId: eventId,
                name: name,
                price: parseFloat(price),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                document.getElementById('expenseName').value = '';
                document.getElementById('expensePrice').value = '';
            });
        }
        
        function deleteExpense(id) {
            db.collection('eventExpenses').doc(id).delete();
        }
        
        function goBack() {
            window.location.href = `event.html?id=${eventId}`;
        }
    </script>
</body>
</html>
